import{_ as i}from"./2.索引-20250729155429412-6U4zpBfE.js";import{_ as a}from"./1.存储引擎-20250729152625542-DePBCEM8.js";import{a as h,c as k,b as l,o as n}from"./app-CAzY0Upz.js";const e="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731183549105-9oblxu8A.png",t="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731183600953-DSVNUk9j.png",p="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731183615002-47X00Tu3.png",d="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731183625285-CeKEV-iz.png",r="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731183808584-DQ7yBYSb.png",g="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731183835620-Ozs5Vq-h.png",A="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731183852302-DNPds1Tr.png",y="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731183923277-BIevlWWO.png",o="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731183931466-DEOYZbtL.png",B="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731183944352-bH8AoaQK.png",c="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731184026243-DuZ_W2VP.png",C="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731184039326-C2_LT7Yb.png",D="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731184109003-BnvgGfI6.png",m="/blog/assets/3.SQL%E4%BC%98%E5%8C%96-20250731184236332-C58tweGc.png",b={};function u(E,s){return n(),k("div",null,s[0]||(s[0]=[l(`<h2 id="_3-1-插入数据" tabindex="-1"><a class="header-anchor" href="#_3-1-插入数据"><span>3.1 插入数据</span></a></h2><h3 id="_3-1-1-insert-语句优化" tabindex="-1"><a class="header-anchor" href="#_3-1-1-insert-语句优化"><span>3.1.1 <code>INSERT</code> 语句优化</span></a></h3><p>如果需要一次性向数据库表中插入多条记录，可以从以下三个方面进行优化：</p><ol><li><p><strong>优化方案一：批量插入数据</strong></p><p>使用一条 <code>INSERT</code> 语句插入多条记录，例如：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">INSERT INTO</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_test </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">VALUES</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Tom</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Cat</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">3</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Jerry</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>相比于多条 <code>INSERT</code> 语句，批量插入可以减少客户端与数据库之间的交互次数，从而提高效率。</p></li><li><p><strong>优化方案二：手动控制事务</strong></p><p>将多条 <code>INSERT</code> 语句放在一个事务中，手动控制事务的开始和结束，例如：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">START TRANSACTION</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">INSERT INTO</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_test </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">VALUES</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Tom</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Cat</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">3</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Jerry</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">INSERT INTO</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_test </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">VALUES</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">4</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Tom</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">5</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Cat</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">6</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Jerry</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">INSERT INTO</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_test </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">VALUES</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">7</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Tom</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Cat</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), (</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">9</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Jerry</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">COMMIT</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样做可以减少事务的提交次数，降低数据库的 <code>I/O</code> 压力。</p></li><li><p><strong>优化方案三：主键顺序插入</strong></p><p>主键顺序插入的性能要高于乱序插入。这是因为在 InnoDB 存储引擎中，表数据都是根据主键顺序组织存放的。如果主键是乱序插入，会导致频繁的页分裂，从而影响性能。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>主键乱序插入 : 8 1 9 21 88 2 4 15 89 5 7 3</span></span>
<span class="line"><span>主键顺序插入 : 1 2 3 4 5 7 8 9 15 21 88 89</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="_3-1-2-大批量插入数据" tabindex="-1"><a class="header-anchor" href="#_3-1-2-大批量插入数据"><span>3.1.2 大批量插入数据</span></a></h3><p>如果一次性需要插入大批量数据（比如：几百万的记录），使用 <code>INSERT</code> 语句插入性能较低，此时可以使用 MySQL 数据库提供的 <code>LOAD</code> 指令进行插入。</p><p>可以通过执行如下指令，将数据脚本文件中的数据加载到表结构中：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 客户端连接服务端时，加上参数 --local-infile</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">mysql </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">--local-infile -u root -P</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 设置全局参数 local_infile 为 1，开启从本地加载文件导入数据的开关</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">set</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> global</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> local_infile </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 执行 load 指令将准备好的数据，加载到表结构中</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">LOAD</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> DATA</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> LOCAL</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> INFILE </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/root/sql1.log</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">INTO</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> TABLE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_user</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">FIELDS TERMINATED </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">BY</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">LINES TERMINATED </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">BY</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">\\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>FIELDS TERMINATED BY &#39;,&#39;</code> 指定字段之间的分隔符为逗号。</li><li><code>LINES TERMINATED BY &#39;\\n&#39;</code> 指定行之间的分隔符为换行符。</li></ul><p>执行 <code>LOAD DATA LOCAL INFILE</code> 语句时，主键顺序插入的性能要高于乱序插入。</p><h2 id="_3-2-主键优化" tabindex="-1"><a class="header-anchor" href="#_3-2-主键优化"><span>3.2 主键优化</span></a></h2><h3 id="_3-2-1-数据组织方式" tabindex="-1"><a class="header-anchor" href="#_3-2-1-数据组织方式"><span>3.2.1 数据组织方式</span></a></h3><p>在 <code>InnoDB</code> 存储引擎中，表数据是根据主键（Primary Key）顺序组织存放的，这种存储方式的表被称为<strong>索引组织表 (Index Organized Table, IOT)</strong>。所有行数据都存储在聚集索引（Clustered Index）的叶子节点上。</p><img src="`+i+'" alt="2.索引-20250729155429412" width="750" style="display:block;margin:auto;"><p><code>InnoDB</code> 的逻辑存储结构从大到小依次为：表空间（Tablespace）、段（Segment）、区（Extent）、页（Page）、行（Row）。</p><img src="'+a+'" alt="1.存储引擎-20250729152625542" width="750" style="display:block;margin:auto;"><ul><li><strong>表空间 (Tablespace)</strong>：<code>InnoDB</code> 存储数据的最高层逻辑单位。</li><li><strong>段 (Segment)</strong>：表空间由多个段组成，常见的有数据段、索引段、回滚段等。</li><li><strong>区 (Extent)</strong>：一个区包含连续的 1MB 存储空间。</li><li><strong>页 (Page)</strong>：页是 <code>InnoDB</code> 管理磁盘的最小单位，默认大小为 16KB。所有数据行都记录在页中。</li><li><strong>行 (Row)</strong>：每一条记录的数据。</li></ul><p>一个页中所能存储的行是有限的。如果插入的数据行 <code>row</code> 在当前页无法完全存储（例如行数据过大或者页已满），将会存储到下一个页中。页与页之间通过指针连接，形成双向链表结构，保持页的逻辑顺序。</p><h3 id="_3-2-2-页分裂" tabindex="-1"><a class="header-anchor" href="#_3-2-2-页分裂"><span>3.2.2 页分裂</span></a></h3><p>页可以为空，也可以填充一半，甚至可以填充 100%。每个页通常至少包含 2 行数据（如果一行数据过大，会发生行溢出）。页中的数据行根据主键顺序排列。</p><p><strong>主键顺序插入效果</strong>：当主键按顺序插入时，<code>InnoDB</code> 会尝试将新数据添加到当前页。</p><ol><li><strong>初始状态</strong>：一个页（例如 1# page）未满，包含若干行数据。 <img src="'+e+'" alt="3.SQL优化-20250731183549105" width="750" style="display:block;margin:auto;"></li><li><strong>继续插入</strong>：新的行数据会继续插入到 1# page 中，直到该页写满。 <img src="'+t+'" alt="3.SQL优化-20250731183600953" width="750" style="display:block;margin:auto;"></li><li><strong>页满后</strong>：当 1# page 写满后，再写入的数据会开辟一个新的页（例如 2# page），并将其通过指针与 1# page 连接。 <img src="'+p+'" alt="3.SQL优化-20250731183615002" width="750" style="display:block;margin:auto;"></li><li><strong>持续插入</strong>：随着数据不断插入，当 2# page 也写满后，会继续开辟 3# page，并将其与 2# page 连接，以此类推。 <img src="'+d+'" alt="3.SQL优化-20250731183625285" width="750" style="display:block;margin:auto;"></li></ol><p>主键顺序插入时，新数据总是追加到当前页的末尾，当当前页满时，才开辟新页，并保持页之间良好的顺序连接。这种方式效率较高，因为数据写入是顺序的，减少了随机 I/O 和页分裂的开销。</p><p><strong>主键乱序插入效果</strong>：当主键乱序插入时，<code>InnoDB</code> 可能会面临性能挑战，主要表现为<strong>页分裂</strong>。</p><ol><li><strong>场景设定</strong>：假设 1# 页和 2# 页已经写满，并且页中的数据是根据主键有序排列的。 <img src="'+r+'" alt="3.SQL优化-20250731183808584" width="750" style="display:block;margin:auto;"></li><li><strong>乱序插入</strong>：此时尝试插入一条 <code>id</code> 为 50 的记录。由于索引结构的叶子节点是有序的，<code>id</code> 为 50 的记录逻辑上应该存储在 <code>id</code> 为 47 的记录之后，即 1# 页中。 <img src="'+g+'" alt="3.SQL优化-20250731183835620" width="750" style="display:block;margin:auto;"></li><li><strong>页满处理</strong>：然而，1# 页已经写满，无法直接插入 <code>id</code> 为 50 的数据。</li><li><strong>页分裂过程</strong>： <ul><li><code>InnoDB</code> 会开辟一个新的页（例如 3# 页）。 <img src="'+A+'" alt="3.SQL优化-20250731183852302" width="750" style="display:block;margin:auto;"></li><li>为了保持数据的主键顺序，1# 页中<strong>一半的数据</strong>（通常是后一半数据）会被移动到新开辟的 3# 页中。 <img src="'+y+'" alt="3.SQL优化-20250731183923277" width="750" style="display:block;margin:auto;"></li><li>然后，<code>id</code> 为 50 的记录会插入到 3# 页的正确位置。 <img src="'+o+'" alt="3.SQL优化-20250731183931466" width="750" style="display:block;margin:auto;"></li><li>最后，为了维护页之间的逻辑顺序，需要重新设置页之间的链表指针，使得 1# 页的下一个页是 3# 页，而 3# 页的下一个页是 2# 页。 <img src="'+B+'" alt="3.SQL优化-20250731183944352" width="750" style="display:block;margin:auto;"></li></ul></li></ol><p><strong>页分裂的本质</strong>：当一个数据页已满，但需要插入的新记录按主键顺序必须放在该页内部时，<code>InnoDB</code> 会创建一个新页，并将原页的一部分数据移动到新页，然后将新记录插入到正确的位置。这个过程会涉及大量的数据移动和指针重定向，导致磁盘 I/O 增加，性能下降。页分裂是比较耗费性能的操作。</p><h3 id="_3-2-3-页合并-page-merge" tabindex="-1"><a class="header-anchor" href="#_3-2-3-页合并-page-merge"><span>3.2.3 页合并 (Page Merge)</span></a></h3><p>当对已有数据进行删除操作时，会引发页合并的可能性，以优化空间使用。</p><img src="'+c+'" alt="3.SQL优化-20250731184026243" width="750" style="display:block;margin:auto;"><ol><li><strong>数据删除</strong>：当删除一行记录时，实际上记录并不会被物理删除，而只是被标记 (flagged) 为删除状态。该行所占据的空间被标记为可用，允许其他记录声明使用。 <img src="'+C+'" alt="3.SQL优化-20250731184039326" width="750" style="display:block;margin:auto;"></li><li><strong>空间回收</strong>：如果一个页中被标记为删除的记录达到 <code>MERGE_THRESHOLD</code>（默认是页的 50%），<code>InnoDB</code> 会开始寻找最靠近的页（前一个或后一个）来尝试将两个页合并，以优化空间使用。 <img src="'+D+'" alt="3.SQL优化-20250731184109003" width="750" style="display:block;margin:auto;"></li><li><strong>页合并过程</strong>：如果满足合并条件，两个相邻的页中的数据会被合并到一个页中，从而释放一个空页。 <img src="'+m+'" alt="3.SQL优化-20250731184236332" width="750" style="display:block;margin:auto;"></li></ol><div class="hint-container info"><p class="hint-container-title">相关信息</p><p><code>MERGE_THRESHOLD</code> 是一个可以自行设置的阈值，可以在创建表或创建索引时指定。</p></div><p>页合并的发生有助于回收因删除操作而产生的碎片空间，提高存储利用率。</p><h3 id="_3-2-4-索引设计原则" tabindex="-1"><a class="header-anchor" href="#_3-2-4-索引设计原则"><span>3.2.4 索引设计原则</span></a></h3><p>基于 <code>InnoDB</code> 的数据组织方式、页分裂与页合并的原理，设计主键时应遵循以下原则：</p><ul><li><strong>满足业务需求的情况下，尽量降低主键的长度</strong>：短主键可以减少索引占用的存储空间，提高缓存命中率，减少磁盘 I/O。</li><li><strong>插入数据时，尽量选择顺序插入，推荐使用 <code>AUTO_INCREMENT</code> 自增主键</strong>：顺序插入可以避免频繁的页分裂，提高插入性能。<code>AUTO_INCREMENT</code> 是实现顺序插入的理想方式，它保证了新插入的主键值总是大于之前的主键值，从而确保数据按顺序追加到页的末尾或新页中，大大减少了页分裂的发生。</li></ul><h2 id="_3-3-order-by-优化" tabindex="-1"><a class="header-anchor" href="#_3-3-order-by-优化"><span>3.3 <code>ORDER BY</code> 优化</span></a></h2><p>MySQL 中，对查询结果进行排序有两种方式：</p><ul><li><code>Using filesort</code>：通过表的索引或全表扫描，读取满足条件的数据行，然后在排序缓冲区 <code>sort buffer</code> 中完成排序操作。所有不是通过索引直接返回排序结果的排序都称为 <code>FileSort</code> 排序。这种方式性能相对较低。</li><li><code>Using index</code>：通过有序索引顺序扫描直接返回有序数据，无需额外的排序操作，效率较高。</li></ul><p>优化排序操作的目标是尽量避免 <code>Using filesort</code>，尽可能地使用 <code>Using index</code>。</p><p>接下来，通过一个测试来演示 <code>ORDER BY</code> 的优化策略：</p><ol><li><p><strong>数据准备</strong></p><p>删除已存在的索引：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">drop</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> index</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> idx_user_phone </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">on</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_user;</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">drop</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> index</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> idx_user_phone_name </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">on</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_user;</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">drop</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> index</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> idx_user_name </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">on</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_user;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>执行排序 SQL</strong></p><p>执行以下 SQL 语句，根据 <code>age</code> 字段进行排序：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">explain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> select</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> id,age,phone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_user</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> order</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> by</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> age</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>+----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+----------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+----------------+ | 1 | SIMPLE | tb_user | NULL | ALL | NULL | NULL | NULL | NULL | 24 | 100.00 | Using filesort | +----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+----------------+ 1 row in set, 1 warning (0.00 sec) ```</p><pre><code>由于 `age` 和 `phone` 都没有索引，所以排序时会出现 `Using filesort`，导致排序性能较低。\n</code></pre><ol start="3"><li><p>创建索引</p><p>为了优化排序，可以创建一个包含 <code>age</code> 和 <code>phone</code> 字段的联合索引：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">create</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> index</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> idx_user_age_phone_aa</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> on</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_user (age,phone);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><strong>创建索引后，根据 <code>age</code> 进行升序排序</strong></p><p>创建索引后，再次执行排序查询：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">explain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> select</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> id,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> age,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_user</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> order</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> by</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> age</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>+----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+-------------+ | 1 | SIMPLE | tb_user | NULL | index | NULL | idx_user_age_phone_aa | 48 | NULL | 24 | 100.00 | Using index | +----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+-------------+ 1 row in set, 1 warning (0.00 sec) ```</p><pre><code>此时，查询计划会显示 `Using index`，表明排序操作直接利用了索引，避免了 `Using filesort`，从而提高了性能。\n</code></pre><ol start="5"><li><p><strong>创建索引后，根据 <code>age</code>, <code>phone</code> 进行降序排序</strong></p><p>如果需要降序排序，可以执行以下 SQL 语句：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">explain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> select</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> id,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> age,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_user</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> order</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> by</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> age</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> desc,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> desc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>+----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+----------------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+----------------------------------+ | 1 | SIMPLE | tb_user | NULL | index | NULL | idx_user_age_phone_aa | 48 | NULL | 24 | 100.00 | Backward index scan; Using index | +----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+----------------------------------+ 1 row in set, 1 warning (0.00 sec) ```</p><pre><code>虽然也会出现 `Using index`，但 `Extra` 列中可能会出现 `Backward index scan`。这表示 MySQL 正在反向扫描索引，因为默认情况下索引的叶子节点是从小到大排序的，而查询要求从大到小排序。在 MySQL 8 及更高版本中，可以使用降序索引来避免反向扫描。\n</code></pre><ol start="6"><li><p><strong>根据 <code>phone</code>, <code>age</code> 进行升序排序（<code>phone</code> 在前，<code>age</code> 在后）</strong></p><p>如果排序字段的顺序与索引字段的顺序不一致，例如：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">explain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> select</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> id,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> age,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_user</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> order</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> by</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phone,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> age</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>+----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+-----------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+-----------------------------+ | 1 | SIMPLE | tb_user | NULL | index | NULL | idx_user_age_phone_aa | 48 | NULL | 24 | 100.00 | Using index; Using filesort | +----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+-----------------------------+ 1 row in set, 1 warning (0.00 sec) ```</p><pre><code>由于排序时未遵循最左前缀法则，仍然会出现 `Using filesort`。\n</code></pre><ol start="7"><li><p><strong>根据 <code>age</code>, <code>phone</code> 进行排序，一个升序，一个降序</strong></p><p>如果排序规则不一致（一个升序，一个降序），例如：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">explain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> select</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> id,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> age,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_user</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> order</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> by</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> age</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> asc,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> desc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>+----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+-----------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+-----------------------------+ | 1 | SIMPLE | tb_user | NULL | index | NULL | idx_user_age_phone_aa | 48 | NULL | 24 | 100.00 | Using index; Using filesort | +----+-------------+---------+------------+-------+---------------+-----------------------+---------+------+------+----------+-----------------------------+ 1 row in set, 1 warning (0.00 sec) ```</p><pre><code>由于创建索引时默认是升序排序，而查询时存在升序和降序的混合排序，此时会出现 `Using filesort`。\n</code></pre><ol start="8"><li><p><strong>创建联合索引 (<code>age</code> 升序排序，<code>phone</code> 倒序排序)</strong></p><p>为了解决上述问题，可以创建特定排序规则的联合索引：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">create</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> index</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> idx_user_age_phone_ad</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> on</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_user (age </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">asc</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, phone </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">desc</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>通过上述测试，可以总结出 <code>ORDER BY</code> 优化的以下原则：</p><ul><li>根据排序字段建立合适的索引。多字段排序时，需要遵循最左前缀法则，确保索引能够被有效利用。</li><li>尽量使用覆盖索引。如果查询的字段都在索引中，可以避免回表查询，提高性能。</li><li>多字段排序时，如果排序规则不一致（既有升序又有降序），需要注意联合索引在创建时的排序规则 (<code>ASC/DESC</code>)，使其与查询的排序规则相匹配。</li><li>如果不可避免地出现 <code>filesort</code>，对于大数据量的排序，可以适当增大排序缓冲区的大小 <code>sort_buffer_size</code>（默认 256KB）。但需要注意的是，增加 <code>sort_buffer_size</code> 可能会消耗更多的内存资源。</li></ul><p>好的，下面是对您提供的课件内容进行的整理和总结，形成一份详尽的笔记。</p><h2 id="_3-4-group-by-优化" tabindex="-1"><a class="header-anchor" href="#_3-4-group-by-优化"><span>3.4 <code>GROUP BY</code> 优化</span></a></h2><p>本节主要探讨索引对分组操作的影响，通过实验来观察索引如何提升 <code>GROUP BY</code> 语句的性能。</p><ol><li><p><strong>数据准备</strong> 首先，删除 <code>tb_user</code> 表上的所有索引：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">drop</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> index</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> idx_user_pro_age_sta </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">on</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_user;</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">drop</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> index</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> idx_email_5 </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">on</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_user;</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">drop</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> index</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> idx_user_age_phone_aa </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">on</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_user;</span></span>\n<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">drop</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> index</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> idx_user_age_phone_ad </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">on</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_user;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>无索引情况下的分组查询</strong></p><p>在没有任何索引的情况下，执行以下 SQL 语句，并查看其执行计划：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">explain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> select</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> profession,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_user</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> group</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> by</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> profession</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>+----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-----------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-----------------+ | 1 | SIMPLE | tb_user | NULL | ALL | NULL | NULL | NULL | NULL | 24 | 100.00 | Using temporary | +----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-----------------+ 1 row in set, 1 warning (0.00 sec) ``` - <strong><code>type</code> 为 <code>ALL</code></strong> ：这意味着 MySQL 需要对整个 <code>tb_user</code> 表进行全表扫描。 - <strong><code>possible_keys</code> 和 <code>key</code> 都为 <code>NULL</code></strong> ：这表明 MySQL 认为没有任何索引可以用于优化这个查询。因此，它选择进行全表扫描。 - <strong><code>Extra</code> 为 <code>Using temporary</code></strong> ：这意味着 MySQL 需要创建一个临时表来存储 <code>GROUP BY</code> 的结果。 全表扫描后，MySQL 需要将数据放入临时表进行分组和计数，这会消耗大量的磁盘 I/O 和 CPU 资源。</p><ol start="3"><li><p><strong>创建索引后的分组查询</strong></p><p>接下来，创建一个联合索引，包含 <code>profession</code>, <code>age</code> 和 <code>status</code> 字段：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">create</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> index</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> idx_user_pro_age_sta</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> on</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tb_user (profession, age, </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">status</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>创建索引后，再次执行相同的 SQL 语句，并查看执行计划：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">explain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> select</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> profession,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_user</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> group</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> by</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> profession</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>+----+-------------+---------+------------+-------+----------------------+----------------------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+----------------------+----------------------+---------+------+------+----------+-------------+ | 1 | SIMPLE | tb_user | NULL | index | idx_user_pro_age_sta | idx_user_pro_age_sta | 54 | NULL | 24 | 100.00 | Using index | +----+-------------+---------+------------+-------+----------------------+----------------------+---------+------+------+----------+-------------+ 1 row in set, 1 warning (0.00 sec) ``` - <strong><code>type</code> 为 <code>index</code></strong> ：这表示 MySQL 使用了索引来查找行，但不是通过直接查找特定的索引值，而是扫描整个索引。 - <strong><code>possible_keys</code> 和 <code>key</code> 都显示为 <code>idx_user_pro_age_sta</code></strong> ：这表明 MySQL 能够使用 <code>idx_user_pro_age_sta</code> 索引来优化查询。 - <strong><code>Extra</code> 为 <code>Using index</code></strong> ：这意味着 MySQL 可以直接从索引中获取所需的数据，而无需访问实际的数据行（数据表）。</p><ol start="4"><li><p><strong>联合索引与最左前缀法则</strong></p><p>接下来，执行以下不同的分组查询 SQL 语句，并观察执行计划：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">explain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> select</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> profession,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_user</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> group</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> by</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> profession,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> age</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>+----+-------------+---------+------------+-------+----------------------+----------------------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+----------------------+----------------------+---------+------+------+----------+-------------+ | 1 | SIMPLE | tb_user | NULL | index | idx_user_pro_age_sta | idx_user_pro_age_sta | 54 | NULL | 24 | 100.00 | Using index | +----+-------------+---------+------------+-------+----------------------+----------------------+---------+------+------+----------+-------------+ 1 row in set, 1 warning (0.00 sec) ```</p><pre><code>```shell\nmysql&gt; explain select age, count(*) from tb_user group by age;\n</code></pre><p>+----+-------------+---------+------------+-------+----------------------+----------------------+---------+------+------+----------+------------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+----------------------+----------------------+---------+------+------+----------+------------------------------+ | 1 | SIMPLE | tb_user | NULL | index | idx_user_pro_age_sta | idx_user_pro_age_sta | 54 | NULL | 24 | 100.00 | Using index; Using temporary | +----+-------------+---------+------------+-------+----------------------+----------------------+---------+------+------+----------+------------------------------+ 1 row in set, 1 warning (0.00 sec) ```</p><pre><code>观察结果表明，当仅根据 `age` 字段进行分组时，执行计划中出现了 `Using temporary`，这意味着 MySQL 使用了临时表来完成分组操作。而当根据 `profession` 和 `age` 两个字段同时分组时，则没有出现 `Using temporary`。\n\n这是因为对于分组操作，联合索引的使用也遵循最左前缀法则。当 `GROUP BY` 子句中的字段顺序与联合索引的字段顺序一致，或者说是联合索引的最左前缀时，MySQL 可以直接利用索引进行分组，避免了临时表的创建，从而提高了查询效率。\n</code></pre><p>通过以上实验，可以得出以下优化 <code>GROUP BY</code> 语句的策略：</p><ul><li><strong>利用索引提高效率</strong>：在分组操作时，可以通过创建适当的索引来提高效率。索引可以帮助 MySQL 快速定位到需要分组的数据，避免全表扫描和临时表的创建。</li><li><strong>遵循最左前缀法则</strong>：分组操作时，索引的使用同样需要满足最左前缀法则。这意味着 <code>GROUP BY</code> 子句中的字段顺序应该与索引中的字段顺序一致，或者说是索引的最左前缀。</li></ul><p>总而言之，合理地设计和使用索引，可以显著提升 <code>GROUP BY</code> 语句的性能。在实际应用中，需要根据具体的业务场景和查询需求，选择合适的索引策略。</p><h2 id="_3-5-limit-优化" tabindex="-1"><a class="header-anchor" href="#_3-5-limit-优化"><span>3.5 <code>LIMIT</code> 优化</span></a></h2><p>当数据量较大时，使用 <code>LIMIT</code> 进行分页查询，随着分页的页码增加，查询效率会显著降低。例如：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">select</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> *</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_sku</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> limit</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 0,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+----+-----------------+-----------+-------+------+-----------+----------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------+--------+---------------------+---------------------+---------------+------------+-------+----------+-------------+--------+</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> id</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sn</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">              |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> price</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> alert_num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> image</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                                                                                                                      |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> images</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                                                                                                                     |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> weight</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> create_time</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">         |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> update_time</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">         |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> category_name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> brand_name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> spec</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sale_num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> comment_num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> status</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+----+-----------------+-----------+-------+------+-----------+----------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------+--------+---------------------+---------------------+---------------+------------+-------+----------+-------------+--------+</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 100000003145001</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 华为Meta1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 87901</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 9961</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       100</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t5590/64/5811657380/234462/5398e856/5965e173N34179777.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t5590/64/5811657380/234462/5398e856/5965e173N34179777.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     10</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 真皮包</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> viney</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 白色1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       39</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">           0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  2</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 100000003145002</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 华为Meta2</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     3</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 9946</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       100</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t23998/350/2363990466/222391/a6e9581d/5b7cba5bN0c18fb4f.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t23998/350/2363990466/222391/a6e9581d/5b7cba5bN0c18fb4f.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     10</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 拉拉裤</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 巴布豆</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">     |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 白色2</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       54</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">           0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  3</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 100000003145003</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 华为Meta3</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 78903</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 9993</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       100</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t1/25363/12/2929/274060/5c21df3aE1789bda7/030af31afd116ae0.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t1/25363/12/2929/274060/5c21df3aE1789bda7/030af31afd116ae0.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     10</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 拉杆箱</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 莎米特</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">     |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 白色3</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        7</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">           0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+----+-----------------+-----------+-------+------+-----------+----------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------+--------+---------------------+---------------------+---------------+------------+-------+----------+-------------+--------+</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">3</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rows</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (0.00 </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sec</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">select</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> *</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_sku</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> limit</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 1000000,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+---------+-----------------------+-----------------+-------+-------+-----------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------+--------+---------------------+---------------------+---------------+------------+-------------+----------+-------------+--------+</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> id</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sn</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                    |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">            |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> price</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> alert_num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> image</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                                                                                                                   |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> images</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                                                                                                                  |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> weight</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> create_time</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">         |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> update_time</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">         |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> category_name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> brand_name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> spec</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sale_num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> comment_num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> status</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+---------+-----------------------+-----------------+-------+-------+-----------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------+--------+---------------------+---------------------+---------------+------------+-------------+----------+-------------+--------+</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1000001</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 100000003145001000001</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 华为Meta1000001</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 92001</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 10000</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       100</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t18196/293/2136823958/421330/7e75be4b/5ae83333Nae68e60d.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t18196/293/2136823958/421330/7e75be4b/5ae83333Nae68e60d.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     10</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 老花镜</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 又一春</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">     |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 白色1000001</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">           0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1000002</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 100000003145001000002</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 华为Meta1000002</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 52002</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 10000</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       100</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t18196/293/2136823958/421330/7e75be4b/5ae83333Nae68e60d.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t18196/293/2136823958/421330/7e75be4b/5ae83333Nae68e60d.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     10</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 老花镜</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 又一春</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">     |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 白色1000002</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">           0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1000003</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 100000003145001000003</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 华为Meta1000003</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 70003</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 10000</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       100</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t18196/293/2136823958/421330/7e75be4b/5ae83333Nae68e60d.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t18196/293/2136823958/421330/7e75be4b/5ae83333Nae68e60d.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     10</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 老花镜</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 又一春</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">     |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 白色1000003</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">           0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+---------+-----------------------+-----------------+-------+-------+-----------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------+--------+---------------------+---------------------+---------------+------------+-------------+----------+-------------+--------+</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">3</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rows</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (3.79 </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sec</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">select</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> *</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_sku</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> limit</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 5000000,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+---------+-----------------------+-----------------+--------+-------+-----------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+--------+---------------------+---------------------+---------------+------------+-------------+----------+-------------+--------+</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> id</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sn</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                    |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">            |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> price</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> alert_num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> image</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                                                                                                                  |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> images</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                                                                                                                 |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> weight</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> create_time</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">         |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> update_time</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">         |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> category_name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> brand_name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> spec</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sale_num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> comment_num</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> status</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+---------+-----------------------+-----------------+--------+-------+-----------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+--------+---------------------+---------------------+---------------+------------+-------------+----------+-------------+--------+</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 5000001</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 100000003145005000001</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 华为Meta5000001</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  83301</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 10000</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       100</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t23416/164/1114672941/97718/7a52de73/5b51a552Na67d01ef.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t23416/164/1114672941/97718/7a52de73/5b51a552Na67d01ef.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     10</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 休闲鞋</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 森马</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 白色5000001</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">           0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 5000002</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 100000003145005000002</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 华为Meta5000002</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 127202</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 10000</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       100</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t23416/164/1114672941/97718/7a52de73/5b51a552Na67d01ef.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t23416/164/1114672941/97718/7a52de73/5b51a552Na67d01ef.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     10</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 休闲鞋</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 森马</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 白色5000002</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">           0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 5000003</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 100000003145005000003</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 华为Meta5000003</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 145403</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 10000</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       100</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t23416/164/1114672941/97718/7a52de73/5b51a552Na67d01ef.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> https://m.360buyimg.com/mobilecms/s720x720_jfs/t23416/164/1114672941/97718/7a52de73/5b51a552Na67d01ef.jpg!q70.jpg.webp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     10</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2019-05-01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 休闲鞋</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 森马</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 白色5000003</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">           0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+---------+-----------------------+-----------------+--------+-------+-----------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+--------+---------------------+---------------------+---------------+------------+-------------+----------+-------------+--------+</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">3</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rows</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (17.48 </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sec</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在执行 <code>LIMIT 2000000, 10</code> 这样的查询时，MySQL 需要先扫描并排序 2000010 条记录，然后只返回最后的 10 条，丢弃前面 2000000 条记录。这种先扫描大量数据再丢弃的方式导致查询代价非常大。</p><p>通常，可以通过创建覆盖索引来提高分页查询的性能。一种常见的优化方法是使用覆盖索引加子查询的方式。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">explain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> select</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> *</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_sku</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> t</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (select </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">id</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> from</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_sku</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> order</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> by</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> id</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> limit</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 2000000,10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">) a where t.id = a.id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+----+-------------+------------+------------+--------+---------------+---------+---------+------+---------+----------+-------------+</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> id</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> select_type</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> table</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> partitions</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> type</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> possible_keys</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> key</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">     |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> key_len</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ref</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> rows</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> filtered</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Extra</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       |</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+----+-------------+------------+------------+--------+---------------+---------+---------+------+---------+----------+-------------+</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> PRIMARY</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">     |</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">derived2</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NULL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ALL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NULL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">          |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NULL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NULL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NULL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2000010</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   100.00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NULL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> PRIMARY</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">     |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> t</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">          |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NULL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> eq_ref</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> PRIMARY</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> PRIMARY</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 4</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> a.id</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   100.00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NULL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span></span>\n<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  2</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> DERIVED</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">     |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> tb_sku</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">     |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NULL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> index</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NULL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">          |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> PRIMARY</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 4</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> NULL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 2000010</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   100.00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Using</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> index</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+----+-------------+------------+------------+--------+---------------+---------+---------+------+---------+----------+-------------+</span></span>\n<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">3</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rows</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> warning</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (0.00 </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sec</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这条 SQL 语句的核心在于利用子查询和覆盖索引来避免全表扫描。子查询 <code>(SELECT id FROM tb_sku ORDER BY id LIMIT 2000000,10)</code> 的作用是：</p><ol><li><strong>覆盖索引：</strong> 由于 <code>id</code> 是主键，因此对 <code>id</code> 的查询可以直接使用主键索引，无需回表查询其他列的数据。<code>Extra</code> 列的 <code>Using index</code> 也证实了这一点。</li><li><strong>延迟关联：</strong> 子查询先通过索引快速定位到所需的 <code>id</code> 范围，然后主查询再根据这些 <code>id</code> 值来获取完整的行数据。这避免了在整个大表中进行 <code>LIMIT</code> 操作，从而提高了性能。</li></ol><h2 id="_3-6-count-优化" tabindex="-1"><a class="header-anchor" href="#_3-6-count-优化"><span>3.6 <code>COUNT</code> 优化</span></a></h2><p>在数据库性能测试中，当数据量庞大时，执行 <code>COUNT</code> 操作会显著增加耗时。这主要源于不同存储引擎的底层实现机制差异：</p><ul><li><strong>MyISAM 引擎</strong>：将表的总行数持久化存储于磁盘中。当执行 <code>COUNT(*)</code> 时，引擎直接返回该预存数值，效率极高。然而，对于带条件的 <code>COUNT</code>（如 <code>WHERE</code> 子句），由于需逐行扫描，效率会显著降低。</li><li><strong>InnoDB 引擎</strong>：在执行 <code>COUNT(*)</code> 时，必须从引擎中逐行读取数据并进行累积计数，导致高资源消耗。 为了提升 InnoDB 表的 <code>COUNT</code> 效率，核心优化思路是<strong>自行维护计数值</strong>。例如，借助外部数据库（如 Redis）存储计数器。该方法挑战在于处理<strong>带条件的 <code>COUNT</code></strong>，如涉及动态筛选条件时，维护开销会大幅增加，使其复杂性提升。</li></ul><p>接下来，我们将详细解析 <code>COUNT</code> 的操作原理及其变体，提供具体优化依据。</p><p><code>COUNT</code> 作为聚合函数，其工作机制是对结果集逐行判断：若参数值非 <code>NULL</code>，则累加器递增 1；否则跳过。最后返回累计值。主要用法包括 <code>COUNT(*)</code>、<code>COUNT(主键)</code>、<code>COUNT(字段)</code> 和 <code>COUNT(数字)</code>。下表详述了每种用法在 InnoDB 引擎中的行为：</p><table><thead><tr><th style="text-align:left;"><code>COUNT</code> 用法</th><th style="text-align:left;">InnoDB 引擎行为</th></tr></thead><tbody><tr><td style="text-align:left;"><code>COUNT(主键)</code></td><td style="text-align:left;">引擎遍历全表，提取每行的主键 <code>id</code> 值并返回至服务层。服务层直接按行累加（因主键永不 <code>NULL</code>）。</td></tr><tr><td style="text-align:left;"><code>COUNT(字段)</code></td><td style="text-align:left;"><strong>无 <code>NOT NULL</code> 约束</strong>：引擎遍历全表，提取每行字段值至服务层；服务层判断非 <code>NULL</code> 时累加。<br> <strong>有 <code>NOT NULL</code> 约束</strong>：引擎提取字段值至服务层后，服务层直接按行累加。</td></tr><tr><td style="text-align:left;"><code>COUNT(数字)</code></td><td style="text-align:left;">引擎遍历全表但不取值；服务层为每行放置数字 <code>1</code>，并按行累加。</td></tr><tr><td style="text-align:left;"><code>COUNT(*)</code></td><td style="text-align:left;">引擎进行专门优化（不提取具体字段），服务层直接按行累加。</td></tr></tbody></table><p>按照效率排序，<code>COUNT(字段) &lt; COUNT(主键 id) &lt; COUNT(1) ≈ COUNT(*)</code>，因此，应优先使用 <strong><code>COUNT(*)</code></strong> 以最大化效率。其优化机制避免了不必要的数据提取，显著减少 I/O 开销。</p><h2 id="_3-7-update-优化" tabindex="-1"><a class="header-anchor" href="#_3-7-update-优化"><span>3.7 <code>UPDATE</code> 优化</span></a></h2><p>在执行 SQL <code>UPDATE</code> 语句时，需要特别注意锁机制对性能的影响。锁的粒度（行锁或表锁）直接决定操作的并发性和效率，优化不当会导致性能显著下降。</p><div class="hint-container example"><p class="hint-container-title">索引字段与行锁</p><p>基于索引列（如主键 <code>id</code>）执行 <code>UPDATE</code>：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">UPDATE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> course </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SET</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">javaEE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> WHERE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> id </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>该语句在执行时，InnoDB 引擎会根据 <code>id = 1</code> 的索引条件锁定对应的单行数据（行锁），确保数据一致性。事务提交后，行锁自动释放。这种锁机制允许高并发操作，因为锁的粒度小，仅影响特定记录。</p></div><div class="hint-container example"><p class="hint-container-title">非索引字段与锁升级</p><p>使用非索引列（如 <code>name</code>）执行 <code>UPDATE</code>：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">UPDATE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> course </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SET</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">SpringBoot</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> WHERE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">PHP</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果并发开启多个事务执行该语句，InnoDB 将原本的行锁升级为表锁，此时整个表被锁定。这种升级源于 <code>WHERE name = &#39;PHP&#39;</code> 中 <code>name</code> 字段缺乏有效索引，导致索引失效。表锁降低了并发性和性能：其他事务的读写操作会被阻塞，直到当前事务释放表锁。</p></div><p>InnoDB 的行锁机制依赖于索引：锁是针对索引而非物理记录的抽象结构施加的。如果 <code>WHERE</code> 子句涉及未索引字段或索引失效（例如全表扫描），锁将从行级升级为表级。为优化性能，应确保 <code>UPDATE</code> 语句中的条件字段：</p><ul><li>是有效的索引列（如主键或唯一索引）。</li><li>避免不必要的字段操作，以减少锁冲突和性能瓶颈。</li></ul><p>通过优化索引设计，可以避免锁升级，维持高效的行锁并发处理能力。</p>',97)]))}const L=h(b,[["render",u]]),x=JSON.parse('{"path":"/notes/HMMySQL/hrd9nqj3/","title":"SQL优化","lang":"zh-CN","frontmatter":{"title":"SQL优化","createTime":"2025/07/31 17:57:39","permalink":"/notes/HMMySQL/hrd9nqj3/"},"readingTime":{"minutes":21.12,"words":6336},"git":{"createdTime":1754044483000,"updatedTime":1754044483000,"contributors":[{"name":"dead_summer","username":"","email":"2941325451@qq.com","commits":1,"avatar":"https://gravatar.com/avatar/d7f172441d823f01ad688f425860dbe76a31ea11c9936176bbd8c14670a619f8?d=retro"}]},"filePathRelative":"notes/黑马程序员MySQL/2.进阶篇/3.SQL优化.md","headers":[]}');export{L as comp,x as data};
